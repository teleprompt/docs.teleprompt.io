(window.webpackJsonp=window.webpackJsonp||[]).push([[8],{143:function(e,t,n){"use strict";n.r(t),n.d(t,"frontMatter",(function(){return r})),n.d(t,"metadata",(function(){return s})),n.d(t,"rightToc",(function(){return l})),n.d(t,"default",(function(){return c}));var o=n(2),i=n(9),a=(n(0),n(154)),r={title:"npm publish with 2FA",description:"Publishing an npm package with enabled two-factor auth in GitHub Actions or Travis CI",keywords:["npm","publish","2fa","otp","teleprompt","continuous integration","git","travis ci","github actions"]},s={id:"recipes/npm-publish",title:"npm publish with 2FA",description:"Publishing an npm package with enabled two-factor auth in GitHub Actions or Travis CI",source:"@site/docs/recipes/npm-publish.md",permalink:"/recipes/npm-publish",editUrl:"https://github.com/teleprompt/docs.teleprompt.io/edit/master/docs/recipes/npm-publish.md",sidebar:"recipesSidebar",previous:{title:"Overview",permalink:"/recipes/index"}},l=[{value:"Getting the keys",id:"getting-the-keys",children:[]},{value:"GitHub Actions",id:"github-actions",children:[]},{value:"Travis CI",id:"travis-ci",children:[]},{value:"Other CI providers",id:"other-ci-providers",children:[]},{value:"Why is on-publish 2FA so important?",id:"why-is-on-publish-2fa-so-important",children:[]}],p={rightToc:l};function c(e){var t=e.components,n=Object(i.a)(e,["components"]);return Object(a.b)("wrapper",Object(o.a)({},p,n,{components:t,mdxType:"MDXLayout"}),Object(a.b)("p",null,"Let's put teleprompt to good use and publish an npm package every time we create a new git tag \ud83d\ude80"),Object(a.b)("p",null,"What's so special about that? It will work with the secure on-publish two-factor authentication (2FA) setting enabled on our npm account. We shall use teleprompt.io to ask you for the 2FA token whenever we are about to publish."),Object(a.b)("p",null,"The additional benefit is that you can rest assured that the CI can never publish without your consent as it lacks half of the credentials. You will receive a notification and authorize every ",Object(a.b)("inlineCode",{parentName:"p"},"npm publish")," in a few seconds."),Object(a.b)("h2",{id:"getting-the-keys"},"Getting the keys"),Object(a.b)("p",null,"Our goal is to publish when a new git tag is pushed or a new release is created in GitHub. Let's start by logging in to ",Object(a.b)("a",Object(o.a)({parentName:"p"},{href:"https://npmjs.com"}),"npmjs.com")," and ",Object(a.b)("a",Object(o.a)({parentName:"p"},{href:"https://teleprompt.io/dashboard"}),"teleprompt.io")," to collect our credentials."),Object(a.b)("p",null,"First, let's log in to npmjs.com and check out the ",Object(a.b)("inlineCode",{parentName:"p"},"Auth Tokens")," settings page. Create a new token with publishing rights and keep the actual token at hand. You might also want to check our two-factor auth settings while you are here."),Object(a.b)("p",null,"Secondly, log in to the ",Object(a.b)("a",Object(o.a)({parentName:"p"},{href:"https://teleprompt.io/dashboard"}),"Teleprompt Dashboard"),". Choose ",Object(a.b)("inlineCode",{parentName:"p"},"Projects")," from the main menu on the left and create a new project for your repository. After choosing an arbitrary name and submitting the project creation form, an API key will be created for you automatically. Keep this API key at hand, too."),Object(a.b)("h2",{id:"github-actions"},"GitHub Actions"),Object(a.b)("p",null,"Read here how to set up automatic publishing in GitHub Actions now. You can find instructions for other CI environments below."),Object(a.b)("p",null,"Head over to your GitHub repository's settings and ",Object(a.b)("a",Object(o.a)({parentName:"p"},{href:"https://help.github.com/en/actions/configuring-and-managing-workflows/creating-and-storing-encrypted-secrets#creating-encrypted-secrets-for-a-repository"}),"create the following secrets"),":"),Object(a.b)("ul",null,Object(a.b)("li",{parentName:"ul"},Object(a.b)("inlineCode",{parentName:"li"},"NPM_TOKEN")," \u2013 Your npm authentication token"),Object(a.b)("li",{parentName:"ul"},Object(a.b)("inlineCode",{parentName:"li"},"TELEPROMPT_KEY")," \u2013 Your teleprompt API key")),Object(a.b)("p",null,"Let's ",Object(a.b)("a",Object(o.a)({parentName:"p"},{href:"https://help.github.com/en/actions/configuring-and-managing-workflows/configuring-a-workflow#creating-a-workflow-file"}),"create a new workflow now"),". We will call the workflow file ",Object(a.b)("inlineCode",{parentName:"p"},"build.yml")," and start with an empty workflow file."),Object(a.b)("p",null,"Paste the following workflow configuration into our new workflow."),Object(a.b)("pre",null,Object(a.b)("code",Object(o.a)({parentName:"pre"},{className:"language-yaml"}),'# This is a basic workflow to help you get started with Actions\n\nname: npm package CI\n\n# Controls when the action will run. Triggers the workflow on push or pull request\n# events but only for the master branch\non:\n  push:\n    tag: [ master ]\n  release:\n    types: [created]\n\n# A workflow run is made up of one or more jobs that can run sequentially or in parallel\njobs:\n  # This workflow contains a single job called "build"\n  build:\n    # The type of runner that the job will run on\n    runs-on: ubuntu-latest\n\n    # Steps represent a sequence of tasks that will be executed as part of the job\n    steps:\n    - uses: actions/setup-node@v1.4.2\n      with:\n        node-version: 12.x\n\n    # Checks-out your repository under $GITHUB_WORKSPACE, so your job can access it\n    - name: Checkout\n      uses: actions/checkout@v2.2.0\n\n    # Install\n    - run: npm ci\n\n    # Test\n    - run: npm test\n\n    # Publish\n    - name: npm publish\n      run: |\n        echo "//registry.npmjs.org/:_authToken=\\${NPM_TOKEN}" > .npmrc\n        npm version from-git --allow-same-version\n        npm publish $(npx teleprompt --output-format cli --prompt "otp:otp:2FA Token")\n      env:\n        NPM_TOKEN: ${{ secrets.NPM_TOKEN }}\n        TELEPROMPT_KEY: ${{ secrets.TELEPROMPT_KEY }}\n')),Object(a.b)("p",null,"The last few lines is where the magic happens: We use ",Object(a.b)("inlineCode",{parentName:"p"},"npx")," to download and run the ",Object(a.b)("inlineCode",{parentName:"p"},"teleprompt")," client and use it to feed the ",Object(a.b)("inlineCode",{parentName:"p"},"otp")," option to ",Object(a.b)("inlineCode",{parentName:"p"},"npm publish"),". You can find the details how to use the teleprompt command line client ",Object(a.b)("a",Object(o.a)({parentName:"p"},{href:"../docs/cli-client-usage"}),"here"),"."),Object(a.b)("p",null,"That's it! Try to create a tag / release in GitHub \u2013 once the last job in the workflow is run, you should receive an email from teleprompt.io, asking you to provide the required information."),Object(a.b)("h2",{id:"travis-ci"},"Travis CI"),Object(a.b)("p",null,'We assume you have already added your repository to Travis CI. Let\'s open it and head over to the Travis CI settings for this repository. Under "Environment Variables" make sure to add your secrets:'),Object(a.b)("ul",null,Object(a.b)("li",{parentName:"ul"},Object(a.b)("inlineCode",{parentName:"li"},"NPM_TOKEN")," \u2013 Your npm authentication token"),Object(a.b)("li",{parentName:"ul"},Object(a.b)("inlineCode",{parentName:"li"},"TELEPROMPT_KEY")," \u2013 Your teleprompt API key")),Object(a.b)("p",null,"Do not restrict these secret environment variables to certain branches as we will build per git tag and Travis CI won't associate the tag with the branch you tagged."),Object(a.b)("p",null,"Create a ",Object(a.b)("inlineCode",{parentName:"p"},".travis.yml")," file with the following content."),Object(a.b)("pre",null,Object(a.b)("code",Object(o.a)({parentName:"pre"},{className:"language-yaml"}),'language: node_js\ncache: npm\nnode_js:\n  - "12"\n\nstages:\n  - name: test\n  - name: publish\n    if: tag =~ /^v?[0-9]+\\.[0-9]+\\.[0-9]/\n\njobs:\n  include:\n    - stage: test\n      script: npm test\n    - stage: publish\n      before_script:\n        - echo "//registry.npmjs.org/:_authToken=\\${NPM_TOKEN}" > .npmrc\n      script:\n        - npm version $(echo $TRAVIS_TAG | sed s/^v//) --allow-same-version\n        - npm publish $(npx teleprompt --output-format cli --prompt "otp:otp:2FA Token")\n')),Object(a.b)("p",null,"That's it! Try to create a tag and wait for the build to reach the ",Object(a.b)("inlineCode",{parentName:"p"},"npm publish")," step. You should receive an email from teleprompt.io, asking you to provide the required information."),Object(a.b)("h2",{id:"other-ci-providers"},"Other CI providers"),Object(a.b)("p",null,"There are of course more CI providers, like GitLab CI, Circle CI, Jenkins CI, Atlassian Bamboo, AppVeyor and others."),Object(a.b)("p",null,"We will not go into details for all those CI providers, but the setup is generally very similar in all of them. Check out the examples above and your CI tool's documentation to create your own setup."),Object(a.b)("h2",{id:"why-is-on-publish-2fa-so-important"},"Why is on-publish 2FA so important?"),Object(a.b)("p",null,"Without teleprompt.io there is hardly a simple way to achieve the setup outlined above. It is trivial to create a similar setup if the npm 2FA setting is set to auth-only, but that this option provides insufficient security for publishing in CI."),Object(a.b)("p",null,"There are multiple ways how a malicious actor could obtain your npm authentication token from your CI environment. For instance, the npm token environment variable might be set when running the tests for an externally-contributed pull request due to some simple misconfiguration. Alternatively, your CI provider might suffer from an information expose vulnerability that reveals environment variables or files."),Object(a.b)("p",null,"In case of two-factor authentication being disabled or auth-only only, an attacker who got hold of your npm authentication token is immediately able to publish new versions containing arbitrary code."),Object(a.b)("p",null,"Not so with on-publish 2FA: In order to publish to npm you still need the current 2FA token. Even if the attacker also obtained the teleprompt API key from your CI environment, they ",Object(a.b)("strong",{parentName:"p"},"can only use it to ask you for the 2FA token"),"."),Object(a.b)("p",null,"That's what makes this setup so secure: Even in the worst case scenario you are still in charge of the credentials."))}c.isMDXComponent=!0}}]);